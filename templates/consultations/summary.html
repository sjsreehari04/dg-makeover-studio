{% extends 'base.html' %}
{% block content %}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-images text-info me-3"></i>
                        Photos & Summary
                    </h2>
                    <p class="text-muted mb-0">{{ consultation.customer.name }}</p>
                </div>
                <div>
                    <a href="{% url 'consultation_detail' consultation.id %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Back to Consultation
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Upload Form -->
    <div class="row mb-4">
        <div class="col-lg-10 mx-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-camera me-2"></i>
                        Upload Before & After Photos
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="row g-4">
                            <!-- Before Photos -->
                            <div class="col-md-6">
                                <div class="upload-section">
                                    <h6 class="fw-bold text-muted mb-3">
                                        <i class="bi bi-image me-2"></i>Before Photos/Videos
                                    </h6>
                                    <div class="upload-area" onclick="document.getElementById('before_media').click()">
                                        <div class="upload-icon">
                                            <i class="bi bi-cloud-upload"></i>
                                        </div>
                                        <p class="mb-1">Click to upload before photos</p>
                                        <small class="text-muted">Multiple files allowed • Supports HEIC, JPEG, PNG, MP4</small>
                                    </div>
                                    <input type="file" name="before_media" id="before_media" multiple
                                           accept="image/*,.heic,.heif,video/*" class="d-none"
                                           onchange="previewMedia(this, 'beforePreview')">
                                    <div class="row g-2 mt-3" id="beforePreview"></div>
                                </div>
                            </div>

                            <!-- After Photos -->
                            <div class="col-md-6">
                                <div class="upload-section">
                                    <h6 class="fw-bold text-muted mb-3">
                                        <i class="bi bi-image me-2"></i>After Photos/Videos
                                    </h6>
                                    <div class="upload-area" onclick="document.getElementById('after_media').click()">
                                        <div class="upload-icon">
                                            <i class="bi bi-cloud-upload"></i>
                                        </div>
                                        <p class="mb-1">Click to upload after photos</p>
                                        <small class="text-muted">Multiple files allowed • Supports HEIC, JPEG, PNG, MP4</small>
                                    </div>
                                    <input type="file" name="after_media" id="after_media" multiple
                                           accept="image/*,.heic,.heif,video/*" class="d-none"
                                           onchange="previewMedia(this, 'afterPreview')">
                                    <div class="row g-2 mt-3" id="afterPreview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consultation Summary -->
    <div class="row mb-4">
        <div class="col-lg-10 mx-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-journal-text me-2"></i>
                        Consultation Summary
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-12">
                            <label for="suggested_treatment" class="form-label fw-semibold">Suggested Treatment Plan</label>
                            <textarea name="suggested_treatment" id="suggested_treatment"
                                      class="form-control" rows="4"
                                      placeholder="Describe the recommended treatment plan, services, and products">{{ summary.suggested_treatment }}</textarea>
                        </div>
                        <div class="col-12">
                            <label for="short_summary" class="form-label fw-semibold">Short Summary for Next Visit</label>
                            <textarea name="short_summary" id="short_summary"
                                      class="form-control" rows="3"
                                      placeholder="Brief notes for the next consultation">{{ summary.short_summary }}</textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between pt-4 border-top mt-4">
                        <a href="{% url 'consultation_detail' consultation.id %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Back
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Save Summary
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Media -->
    {% if media %}
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-folder me-2"></i>
                        Previously Uploaded Media
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for m in media %}
                        <div class="col-md-4 col-sm-6">
                            <div class="media-item">
                                <small class="text-muted d-block mb-1">{{ m.media_type|title }} – {{ m.category|title }}</small>
                                <a href="{{ m.media_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye me-1"></i>View {{ m.media_type|title }}
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    </form>
</div>

<style>
    .card {
        border-radius: 15px;
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    }

    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .upload-area:hover {
        border-color: #0d6efd;
        background: #e3f2fd;
    }

    .upload-icon {
        font-size: 2rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .upload-area:hover .upload-icon {
        color: #0d6efd;
    }

    .preview-image, .preview-video {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .btn-primary {
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    }

    .btn-outline-secondary {
        border-radius: 10px;
        font-weight: 600;
    }

    .media-item {
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .heic-placeholder {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: 500;
        border-radius: 6px;
        min-height: 120px;
    }

    .heic-placeholder i {
        margin-right: 0.5rem;
        font-size: 1.2rem;
    }
</style>

<script>
function previewMedia(input, previewId) {
    const preview = document.getElementById(previewId);
    preview.innerHTML = "";

    Array.from(input.files).forEach(file => {
        const col = document.createElement("div");
        col.className = "col-md-6 col-sm-12";

        const fileName = file.name.toLowerCase();
        const isHeic = fileName.endsWith('.heic') || fileName.endsWith('.heif');

        if (file.type.startsWith("image") || isHeic) {
            const container = document.createElement("div");
            container.className = "preview-container";

            if (isHeic) {
                // For HEIC files, show a placeholder since browsers can't preview them
                const placeholder = document.createElement("div");
                placeholder.className = "heic-placeholder";
                placeholder.innerHTML = `
                    <i class="bi bi-file-earmark-image"></i>
                    <small>HEIC Image</small>
                    <div class="file-name">${file.name}</div>
                `;
                container.appendChild(placeholder);
            } else {
                const img = document.createElement("img");
                img.src = URL.createObjectURL(file);
                img.className = "preview-image";
                container.appendChild(img);
            }

            col.appendChild(container);
        } else if (file.type.startsWith("video")) {
            const video = document.createElement("video");
            video.src = URL.createObjectURL(file);
            video.controls = true;
            video.className = "preview-video";
            col.appendChild(video);
        }

        preview.appendChild(col);
    });
}
</script>

{% endblock %}
