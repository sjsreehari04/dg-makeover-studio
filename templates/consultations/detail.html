{% extends 'base.html' %}
{% block content %}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-clipboard-data-fill text-primary me-3"></i>
                        Consultation Details
                    </h2>
                    <p class="text-muted mb-0">{{ consultation.customer.name }}</p>
                </div>
                <div>
                    <span class="badge {% if consultation.status == 'COMPLETED' %}bg-success{% else %}bg-warning text-dark{% endif %} fs-6 px-3 py-2">
                        {{ consultation.get_status_display }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Consultation Info Card -->
    <div class="row mb-4">
        <div class="col-lg-10 mx-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="text-muted small mb-1">Customer Name</label>
                                <p class="mb-0 fw-normal">{{ consultation.customer.name }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="text-muted small mb-1">Phone Number</label>
                                <p class="mb-0 fw-normal">{{ consultation.customer.phone }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="text-muted small mb-1">Visit Date</label>
                                <p class="mb-0 fw-semibold">{{ consultation.visit_date|date:"l, F d, Y" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="text-muted small mb-1">Created</label>
                                <p class="mb-0 fw-semibold">{{ consultation.created_at|date:"M d, Y \a\t g:i A" }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if consultation.status == 'COMPLETED' %}
    <!-- Complete Consultation View - All Information in One Page -->
    <div class="row g-4">
        <!-- Hair Condition -->
        {% if consultation.hair_condition %}
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-scissors me-2"></i>Hair Condition Assessment
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% if consultation.hair_condition.last_treatment %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Last Treatment</strong>
                            <span>{{ consultation.hair_condition.last_treatment }}</span>
                        </div>
                        {% endif %}
                        {% if consultation.hair_condition.henna_or_black %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Henna/Black</strong>
                            <span>{{ consultation.hair_condition.henna_or_black }}</span>
                        </div>
                        {% endif %}
                        {% if consultation.hair_condition.shampoo %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Shampoo</strong>
                            <span>{{ consultation.hair_condition.shampoo }}</span>
                        </div>
                        {% endif %}
                        {% if consultation.hair_condition.conditioner %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Conditioner</strong>
                            <span>{{ consultation.hair_condition.conditioner }}</span>
                        </div>
                        {% endif %}
                    </div>

                    {% if consultation.hair_condition.home_remedies or consultation.hair_condition.hair_oil or consultation.hair_condition.hair_loss or consultation.hair_condition.dandruff %}
                    <hr class="my-3">
                    <div class="row g-3">
                        {% if consultation.hair_condition.home_remedies %}
                        <div class="col-12">
                            <strong class="text-muted small d-block">Home Remedies</strong>
                            <span>{{ consultation.hair_condition.home_remedy_details|default:"Yes" }}</span>
                        </div>
                        {% endif %}
                        {% if consultation.hair_condition.hair_oil %}
                        <div class="col-12">
                            <strong class="text-muted small d-block">Hair Oil</strong>
                            <span>{{ consultation.hair_condition.hair_oil_details|default:"Yes" }}</span>
                        </div>
                        {% endif %}
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-2">
                                {% if consultation.hair_condition.hair_loss %}
                                <span class="badge bg-danger">Hair Loss</span>
                                {% endif %}
                                {% if consultation.hair_condition.dandruff %}
                                <span class="badge bg-warning">Dandruff</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Skin Condition -->
        {% if consultation.skin_condition %}
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-heart me-2"></i>Skin Condition Assessment
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% if consultation.skin_condition.skin_type %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Skin Type</strong>
                            <span>{{ consultation.skin_condition.skin_type }}</span>
                        </div>
                        {% endif %}
                        {% if consultation.skin_condition.sun_exposure %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Sun Exposure</strong>
                            <span>{{ consultation.skin_condition.get_sun_exposure_display }}</span>
                        </div>
                        {% endif %}
                    </div>

                    {% if consultation.skin_condition.acne or consultation.skin_condition.pigmentation or consultation.skin_condition.wrinkles or consultation.skin_condition.dryness or consultation.skin_condition.comedones %}
                    <hr class="my-3">
                    <div class="mb-3">
                        <strong class="text-muted small d-block mb-2">Skin Concerns</strong>
                        <div class="d-flex flex-wrap gap-2">
                            {% if consultation.skin_condition.acne %}
                            <span class="badge bg-danger">Acne</span>
                            {% endif %}
                            {% if consultation.skin_condition.pigmentation %}
                            <span class="badge bg-dark">Pigmentation</span>
                            {% endif %}
                            {% if consultation.skin_condition.wrinkles %}
                            <span class="badge bg-secondary">Wrinkles</span>
                            {% endif %}
                            {% if consultation.skin_condition.dryness %}
                            <span class="badge bg-info">Dryness</span>
                            {% endif %}
                            {% if consultation.skin_condition.comedones %}
                            <span class="badge bg-warning">Comedones</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="row g-3">
                        {% if consultation.skin_condition.cleanser %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Cleanser</strong>
                            <span>{{ consultation.skin_condition.cleanser }}</span>
                        </div>
                        {% endif %}
                        {% if consultation.skin_condition.toner %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Toner</strong>
                            <span>{{ consultation.skin_condition.toner }}</span>
                        </div>
                        {% endif %}
                        {% if consultation.skin_condition.moisturiser %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Moisturiser</strong>
                            <span>{{ consultation.skin_condition.moisturiser }}</span>
                        </div>
                        {% endif %}
                        {% if consultation.skin_condition.sunscreen %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Sunscreen</strong>
                            <span>{{ consultation.skin_condition.sunscreen }}</span>
                        </div>
                        {% endif %}
                        {% if consultation.skin_condition.serum %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Serum</strong>
                            <span>{{ consultation.skin_condition.serum }}</span>
                        </div>
                        {% endif %}
                        {% if consultation.skin_condition.other %}
                        <div class="col-sm-6">
                            <strong class="text-muted small d-block">Other Products</strong>
                            <span>{{ consultation.skin_condition.other }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Health Condition -->
        {% if consultation.health_condition %}
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-danger text-white py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-activity me-2"></i>Health Condition Assessment
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong class="text-muted small d-block mb-2">Medical Conditions</strong>
                        <div class="d-flex flex-wrap gap-2">
                            {% if consultation.health_condition.pregnancy %}
                            <span class="badge bg-success">Pregnancy</span>
                            {% endif %}
                            {% if consultation.health_condition.pcod %}
                            <span class="badge bg-warning">PCOD</span>
                            {% endif %}
                            {% if consultation.health_condition.thyroid %}
                            <span class="badge bg-info">Thyroid</span>
                            {% endif %}
                            {% if consultation.health_condition.diabetic %}
                            <span class="badge bg-danger">Diabetic</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if consultation.health_condition.allergies %}
                    <div class="mb-3">
                        <strong class="text-muted small d-block">Allergies</strong>
                        <span>{{ consultation.health_condition.allergy_details|default:"Yes" }}</span>
                    </div>
                    {% endif %}

                    {% if consultation.health_condition.medication %}
                    <div class="mb-3">
                        <strong class="text-muted small d-block">Medications</strong>
                        <span>{{ consultation.health_condition.medication_details|default:"Yes" }}</span>
                    </div>
                    {% endif %}

                    {% if consultation.health_condition.vitamin_d_deficiency %}
                    <div class="mb-3">
                        <strong class="text-muted small d-block">Vitamin D Deficiency</strong>
                        <span class="badge bg-warning">Yes</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Services & Billing -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-warning text-dark py-3">
                    <h5 class="mb-0">
                        <i class="bi bi-receipt me-2"></i>Services & Billing
                    </h5>
                </div>
                <div class="card-body">
                    {% if consultation.services.all %}
                    <div class="services-list mb-3">
                        {% for service in consultation.services.all %}
                        <div class="d-flex justify-content-between align-items-center mb-2 py-2 border-bottom">
                            <div>
                                <strong>{{ service.service_name }}</strong>
                            </div>
                            <div class="text-success fw-bold">
                                ₹{{ service.rate }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <hr class="my-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold fs-5">Total Amount:</span>
                        <span class="text-success fw-bold fs-4">₹{{ consultation.calculate_subtotal }}</span>
                    </div>

                    <!-- Show Bill Button -->
                    {% if consultation.bill %}
                    <div class="text-center">
                        <a href="{% url 'bill_detail' consultation.bill.id %}" class="btn btn-primary btn-sm">
                            <i class="bi bi-receipt me-2"></i>Show Bill
                        </a>
                    </div>
                    {% else %}
                    <div class="text-center">
                        <small class="text-muted">Bill not generated yet</small>
                    </div>
                    {% endif %}

                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-info-circle text-muted fs-1 mb-2"></i>
                        <p class="text-muted mb-0">No services were selected for this consultation.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

   <!-- Photos & Consultation Summary -->
{% if before_images or after_images or consultation.summary %}
<div class="col-12">
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-info text-white py-3">
            <h5 class="mb-0">
                <i class="bi bi-images me-2"></i>Photos & Consultation Summary
            </h5>
        </div>

        <div class="card-body">
            <div class="row">

                <!-- BEFORE PHOTOS -->
                {% if before_images %}
                <div class="col-lg-6">
                    <h6 class="mb-3">Before Photos</h6>
                    <div class="row g-3">
                        {% for media in before_images %}
                        <div class="col-md-6">
                            <div class="photo-container">
                                <a href="{{ media.media_file.url}}" target="_blank">
                                    <img src="{{ media.media_file.url }}"
                                         class="img-fluid rounded"
                                         alt="Before photo">
                                </a>
                                <div class="photo-overlay">
                                    <span class="badge bg-dark">Before</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- AFTER PHOTOS -->
                {% if after_images %}
                <div class="col-lg-6">
                    <h6 class="mb-3">After Photos</h6>
                    <div class="row g-3">
                        {% for media in after_images %}
                        <div class="col-md-6">
                            <div class="photo-container">
                                <a href="{{ media.media_file.url }}" target="_blank">
                                    <img src="{{ media.media_file.url }}"
                                         class="img-fluid rounded"
                                         alt="After photo">
                                </a>
                                <div class="photo-overlay">
                                    <span class="badge bg-dark">After</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- CONSULTATION SUMMARY -->
                {% if consultation.summary %}
                <div class="col-12 mt-4">
                    <h6 class="mb-3">Consultation Summary</h6>

                    {% if consultation.summary.suggested_treatment %}
                    <div class="mb-3">
                        <strong class="text-muted small d-block">Suggested Treatment</strong>
                        <p class="mb-0">{{ consultation.summary.suggested_treatment }}</p>
                    </div>
                    {% endif %}

                    {% if consultation.summary.short_summary %}
                    <div>
                        <strong class="text-muted small d-block">Notes for Next Visit</strong>
                        <p class="mb-0">{{ consultation.summary.short_summary }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>
{% endif %}

    {% else %}

    <!-- Consultation Steps -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-4 text-center">
                <i class="bi bi-list-check text-secondary me-2"></i>
                Consultation Steps
            </h4>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <a href="{% url 'hair_condition' consultation.id %}" class="text-decoration-none">
                <div class="card border-0 shadow-sm step-card h-100 {% if hair %}completed{% endif %}">
                    <div class="card-body text-center p-4">
                        <div class="step-icon mb-3">
                            <i class="bi bi-scissors"></i>
                        </div>
                        <h5 class="card-title mb-2">Hair Condition</h5>
                        <p class="card-text text-muted small">Assess hair type, length, and condition</p>
                        {% if hair %}
                        <div class="completion-badge">
                            <i class="bi bi-check-circle-fill text-success"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-4">
            <a href="{% url 'skin_condition' consultation.id %}" class="text-decoration-none">
                <div class="card border-0 shadow-sm step-card h-100 {% if skin %}completed{% endif %}">
                    <div class="card-body text-center p-4">
                        <div class="step-icon mb-3">
                            <i class="bi bi-heart"></i>
                        </div>
                        <h5 class="card-title mb-2">Skin Condition</h5>
                        <p class="card-text text-muted small">Evaluate skin type and concerns</p>
                        {% if skin %}
                        <div class="completion-badge">
                            <i class="bi bi-check-circle-fill text-success"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-4">
            <a href="{% url 'health_condition' consultation.id %}" class="text-decoration-none">
                <div class="card border-0 shadow-sm step-card h-100 {% if health %}completed{% endif %}">
                    <div class="card-body text-center p-4">
                        <div class="step-icon mb-3">
                            <i class="bi bi-activity"></i>
                        </div>
                        <h5 class="card-title mb-2">Health Condition</h5>
                        <p class="card-text text-muted small">Review health and lifestyle factors</p>
                        {% if health %}
                        <div class="completion-badge">
                            <i class="bi bi-check-circle-fill text-success"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row g-3">
        <div class="col-md-6">
            <a href="{% url 'consultation_services' consultation.id %}" class="text-decoration-none">
                <div class="card border-0 shadow-sm action-card h-100">
                    <div class="card-body text-center p-4">
                        <div class="action-icon mb-3">
                            <i class="bi bi-star-fill text-warning"></i>
                        </div>
                        <h5 class="card-title mb-2">Services & Billing</h5>
                        <p class="card-text text-muted small">Select services and generate bill</p>
                        {% if consultation.services.exists %}
                        <div class="completion-badge">
                            <i class="bi bi-check-circle-fill text-success"></i>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-6">
            {% if consultation.services.exists %}
            <a href="{% url 'consultation_summary' consultation.id %}" class="text-decoration-none">
                <div class="card border-0 shadow-sm action-card h-100">
                    <div class="card-body text-center p-4">
                        <div class="action-icon mb-3">
                            <i class="bi bi-images text-info"></i>
                        </div>
                        <h5 class="card-title mb-2">Photos & Summary</h5>
                        <p class="card-text text-muted small">Upload photos and finalize consultation</p>
                    </div>
                </div>
            </a>
            {% else %}
            <div class="card border-0 shadow-sm action-card h-100 disabled-card" style="cursor: not-allowed; opacity: 0.6;">
                <div class="card-body text-center p-4">
                    <div class="action-icon mb-3">
                        <i class="bi bi-images text-muted"></i>
                    </div>
                    <h5 class="card-title mb-2 text-muted">Photos & Summary</h5>
                    <p class="card-text text-muted small">Complete Services & Billing first</p>
                    <div class="text-warning small">
                        <i class="bi bi-lock me-1"></i>Locked - Services required
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Complete Consultation -->
    <div class="row mt-4">
        <div class="col-lg-6 mx-auto">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body text-center py-4">
                    <h6 class="text-muted mb-3">For small makeovers without photos</h6>
                    <form method="post" action="{% url 'consultation_detail' consultation.id %}">
                        {% csrf_token %}
                        <button type="submit" name="action" value="complete" class="btn btn-success btn-lg px-4">
                            <i class="bi bi-check-circle me-2"></i>Complete Consultation
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<style>
    .info-item {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .step-card, .action-card {
        border-radius: 15px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .step-card:hover, .action-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
    }

    .step-card.completed {
        border-left: 4px solid #198754;
    }

    .step-icon, .action-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0 auto;
    }

    .action-icon {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .completion-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.2rem;
    }

    .badge {
        font-weight: 600;
    }

    .btn-success {
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
    }

    .photo-container {
        position: relative;
        overflow: hidden;
        border-radius: 8px;
    }

    .photo-container img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .photo-container:hover img {
        transform: scale(1.05);
    }

    .photo-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
    }

    .services-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .disabled-card {
        pointer-events: none;
    }

    .disabled-card:hover {
        transform: none !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
    }
</style>

{% endblock %}
